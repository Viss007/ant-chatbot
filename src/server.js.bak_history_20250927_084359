import express from "express";

const app = express();
const PORT = process.env.PORT || 3000;

app.use(express.json());

// Health
app.get("/healthz", (req, res) => {
  res.type("text/plain").send("ok");
});

// Robust /api/chat
app.post("/api/chat", async (req, res) => {
  try {
    const b = req.body || {};
    const session_identifier = b.session_identifier ?? b.session_Identifier;
    if (!session_identifier) return res.status(400).json({ error: "Missing session_identifier", received: b });
    if (!b.question || typeof b.question !== "string" || !b.question.trim()) {
      return res.status(400).json({ error: "Missing question", received: b });
    }

    // Log user message
    await supabase.from("messages").insert([{ session_identifier, role: "user", message_text: b.question }]);

    // Produce a trivial reply for now
    const reply = "hello";

    // Log assistant message
    await supabase.from("messages").insert([{ session_identifier, role: "assistant", message_text: reply }]);

    return res.json({ ok: true, reply, session_identifier, question: b.question });
  } catch (e) {
    console.error("CHAT ERROR:", e);
    return res.status(500).json({ error: "internal_error", detail: (e && e.message) || String(e) });
  }
});if (!b.question || typeof b.question !== "string" || !b.question.trim()) {
      return res.status(400).json({ error: "Missing question", received: b });
    }

    // Log user message
    await supabase.from("messages").insert([{ session_identifier, role: "user", message_text: b.question }]);

    // Produce a trivial reply for now
    const reply = "hello";

    // Log assistant message
    await supabase.from("messages").insert([{ session_identifier, role: "assistant", message_text: reply }]);

    return res.json({ ok: true, reply, session_identifier, question: b.question });
  } catch (e) {
    console.error("CHAT ERROR:", e);
    return res.status(500).json({ error: "internal_error", detail: (e && e.message) || String(e) });
  }
});}
    if (!b.question || typeof b.question !== "string" || !b.question.trim()) {
      return res.status(400).json({ error: "Missing question", received: b });
    }
    return res.json({ ok: true, reply: "hello", session_identifier, question: b.question });
  } catch (e) {
    console.error("CHAT ERROR:", e);
    return res.status(500).json({ error: "internal_error", detail: (e && e.message) || String(e) });
  }
});

app.listen(PORT, () => {
  console.log(`http://localhost:${PORT}`);
});


